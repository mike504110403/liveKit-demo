<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HLS Player</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            overflow: hidden;
        }
        
        #video-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
        }
        
        video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-family: Arial, sans-serif;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid white;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        #error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ff6b6b;
            font-family: Arial, sans-serif;
            text-align: center;
            display: none;
        }
    </style>
</head>
<body>
    <div id="video-container">
        <video id="video" controls playsinline></video>
        <div id="loading">
            <div class="spinner"></div>
            <div>ËºâÂÖ•‰∏≠...</div>
        </div>
        <div id="error"></div>
    </div>

    <script>
        const video = document.getElementById('video');
        const loading = document.getElementById('loading');
        const errorDiv = document.getElementById('error');
        let hls = null;

        // Âæû URL ÂèÉÊï∏Áç≤ÂèñÊí≠ÊîæÂú∞ÂùÄ
        function getStreamUrl() {
            const params = new URLSearchParams(window.location.search);
            return params.get('url');
        }

        function showLoading(show) {
            loading.style.display = show ? 'block' : 'none';
        }

        function showError(message) {
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            showLoading(false);
        }

        function initPlayer() {
            const streamUrl = getStreamUrl();
            
            if (!streamUrl) {
                showError('‚ùå Êú™Êèê‰æõÊí≠ÊîæÂú∞ÂùÄ');
                return;
            }

            console.log('üé¨ [HLS Player] ÂàùÂßãÂåñÊí≠ÊîæÂô®');
            console.log('üì∫ [HLS Player] Êí≠ÊîæÂú∞ÂùÄ:', streamUrl);

            if (Hls.isSupported()) {
                console.log('‚úÖ [HLS Player] ÁÄèË¶ΩÂô®ÊîØÊåÅ HLS.js');
                
                hls = new Hls({
                    debug: true,
                    enableWorker: false,            // ÈóúÈñâ WorkerÔºåÁ∞°ÂåñË™øË©¶
                    autoStartLoad: true,            // Ëá™ÂãïÈñãÂßãËºâÂÖ•
                    startPosition: -1,              // ÂæûÁõ¥Êí≠ÈªûÈñãÂßã
                });

                hls.loadSource(streamUrl);
                hls.attachMedia(video);

                hls.on(Hls.Events.MANIFEST_PARSED, function() {
                    console.log('‚úÖ [HLS Player] Manifest Ëß£ÊûêÊàêÂäü');
                    console.log('üìä [HLS Player] Á≠âÁ¥öÊï∏Èáè:', hls.levels.length);
                    showLoading(false);
                    
                    // ÈùúÈü≥ÂæåËá™ÂãïÊí≠ÊîæÔºàÁπûÈÅéÁÄèË¶ΩÂô®ÈôêÂà∂Ôºâ
                    video.muted = true;
                    video.play().then(() => {
                        console.log('‚ñ∂Ô∏è  [HLS Player] Êí≠ÊîæÈñãÂßãÔºàÈùúÈü≥Ôºâ');
                        // 1ÁßíÂæåÂòóË©¶ÂèñÊ∂àÈùúÈü≥
                        setTimeout(() => {
                            video.muted = false;
                            console.log('üîä [HLS Player] Â∑≤ÂèñÊ∂àÈùúÈü≥');
                        }, 1000);
                    }).catch(e => {
                        console.error('‚ùå [HLS Player] Êí≠ÊîæÂ§±Êïó:', e);
                        showError('‚ùå Êí≠ÊîæÂ§±ÊïóÔºåË´ãÈªûÊìäÁï´Èù¢ÊâãÂãïÊí≠Êîæ');
                    });
                });

                hls.on(Hls.Events.ERROR, function(event, data) {
                    console.error('‚ùå [HLS Player] ÈåØË™§:', data);
                    
                    if (data.fatal) {
                        switch(data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                console.error('‚ùå [HLS Player] Á∂≤Áµ°ÈåØË™§ÔºåÂòóË©¶ÊÅ¢Âæ©...');
                                hls.startLoad();
                                break;
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                console.error('‚ùå [HLS Player] Â™íÈ´îÈåØË™§ÔºåÂòóË©¶ÊÅ¢Âæ©...');
                                hls.recoverMediaError();
                                break;
                            default:
                                console.error('‚ùå [HLS Player] ÁÑ°Ê≥ïÊÅ¢Âæ©ÁöÑÈåØË™§');
                                showError('‚ùå Êí≠ÊîæÂ§±Êïó: ' + data.type);
                                hls.destroy();
                                break;
                        }
                    }
                });

                // Áõ£ËÅΩÊí≠Êîæ‰∫ã‰ª∂
                video.addEventListener('playing', () => {
                    console.log('‚ñ∂Ô∏è  [HLS Player] ÈñãÂßãÊí≠Êîæ');
                    console.log('üìä [HLS Player] currentTime:', video.currentTime);
                    showLoading(false);
                });

                video.addEventListener('waiting', () => {
                    console.log('‚è≥ [HLS Player] Á∑©Ë°ù‰∏≠...');
                });

                video.addEventListener('timeupdate', () => {
                    // ÊØèÁßíËº∏Âá∫‰∏ÄÊ¨°ÔºàÈÅøÂÖçÈÅéÂ§öÊó•Ë™åÔºâ
                    if (Math.floor(video.currentTime) % 5 === 0) {
                        console.log('‚è±Ô∏è  [HLS Player] Êí≠ÊîæÈÄ≤Â∫¶:', video.currentTime.toFixed(2), 'Áßí');
                    }
                });

                video.addEventListener('stalled', () => {
                    console.warn('‚ö†Ô∏è  [HLS Player] Êí≠ÊîæÂÅúÊªØ');
                });

                video.addEventListener('error', (e) => {
                    console.error('‚ùå [HLS Player] Video ÂÖÉÁ¥†ÈåØË™§:', e);
                    showError('‚ùå Ë¶ñÈ†ªËºâÂÖ•Â§±Êïó');
                });

            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                console.log('‚úÖ [HLS Player] ÁÄèË¶ΩÂô®ÂéüÁîüÊîØÊåÅ HLS');
                video.src = streamUrl;
                
                video.addEventListener('loadedmetadata', function() {
                    console.log('‚úÖ [HLS Player] ÂÖÉÊï∏ÊìöËºâÂÖ•ÂÆåÊàê');
                    showLoading(false);
                    video.play().catch(e => {
                        console.warn('‚ö†Ô∏è  [HLS Player] Ëá™ÂãïÊí≠ÊîæÂ§±Êïó:', e.message);
                    });
                });

                video.addEventListener('error', (e) => {
                    console.error('‚ùå [HLS Player] Êí≠ÊîæÂ§±Êïó:', e);
                    showError('‚ùå Êí≠ÊîæÂ§±Êïó');
                });
            } else {
                showError('‚ùå ÁÄèË¶ΩÂô®‰∏çÊîØÊåÅ HLS Êí≠Êîæ');
            }
        }

        // Ê∏ÖÁêÜÂáΩÊï∏
        window.addEventListener('beforeunload', () => {
            if (hls) {
                hls.destroy();
            }
        });

        // ÂàùÂßãÂåñ
        initPlayer();
    </script>
</body>
</html>

