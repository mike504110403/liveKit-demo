# SRS Mobile Demo - Cursor Rules

## å°ˆæ¡ˆæ¦‚è¿°
é€™æ˜¯ä¸€å€‹åŸºæ–¼ SRS (Simple Realtime Server) çš„ç§»å‹•ç›´æ’­æ‡‰ç”¨ Demoï¼Œæ”¯æ´ Web å’Œ Mobile å¹³å°ã€‚

### æŠ€è¡“æ£§
- **å‰ç«¯**: Flutter (Web + iOS/Android)
- **å¾Œç«¯**: Go + Gin Framework
- **æµåª’é«”æœå‹™å™¨**: SRS 5.0
- **é€šè¨Š**: WebSocket (æˆ¿é–“ç‹€æ…‹åŒæ­¥ã€èŠå¤©ã€å¿ƒè·³)
- **ç›´æ’­å”è­°**: RTMP (æ¨æµ) + HLS/FLV (æ‹‰æµ)

---

## æ¶æ§‹è¨­è¨ˆ

### 1. ç›´æ’­æµç¨‹
```
ä¸»æ’­ç«¯: OBS â†’ RTMP â†’ SRS
è§€çœ¾ç«¯: 
  - Web: SRS â†’ HLS â†’ video_player
  - Mobile: SRS â†’ HTTP-FLV â†’ fijkplayer
```

### 2. ç‹€æ…‹ç®¡ç†
- æˆ¿é–“ç‹€æ…‹: `idle` (ç­‰å¾…ä¸­) / `live` (ç›´æ’­ä¸­)
- SRS å›èª¿è§¸ç™¼ç‹€æ…‹è®Šæ›´ä¸¦é€šé WebSocket é€šçŸ¥æˆ¿é–“å…§ç”¨æˆ¶
- ç”¨æˆ¶é€²å…¥æˆ¿é–“æ™‚é‡æ–°ç²å–æœ€æ–°ç‹€æ…‹
- ä½¿ç”¨ UniqueKey å¼·åˆ¶é‡å»ºæ’­æ”¾å™¨

### 3. é—œéµçµ„ä»¶

#### å‰ç«¯ (Flutter)
- `adaptive_video_player.dart`: è‡ªé©æ‡‰æ’­æ”¾å™¨
  - Web: video_player + HLS
  - Mobile: fijkplayer + HTTP-FLV
- `player_screen.dart`: æ’­æ”¾å™¨é é¢
  - ç›£è½ WebSocket äº‹ä»¶ (stream_started, stream_stopped)
  - é€²å…¥æ™‚ç²å–æˆ¿é–“æœ€æ–°ç‹€æ…‹
  - ä½¿ç”¨ UniqueKey å¼·åˆ¶é‡å»ºæ’­æ”¾å™¨
- `websocket_service.dart`: WebSocket é€šè¨Šæœå‹™
  - å¿ƒè·³æ©Ÿåˆ¶ï¼ˆ25 ç§’ç™¼é€ä¸€æ¬¡ï¼‰
  - è‡ªå‹•é‡é€£è™•ç†
  - æ¶ˆæ¯é¡å‹åˆ†ç™¼

#### å¾Œç«¯ (Go)
- `srs.go`: SRS å›èª¿è™•ç†
  - `OnPublish`: é–‹å§‹æ¨æµ â†’ å»£æ’­ `stream_started`
  - `OnUnpublish`: åœæ­¢æ¨æµ â†’ å»£æ’­ `stream_stopped`
- `room.go`: æˆ¿é–“ç®¡ç†
  - å‰µå»ºæˆ¿é–“ã€ç²å–æ’­æ”¾ URLã€æ›´æ–°ç‹€æ…‹
- `memory.go`: å…§å­˜å­˜å„² + WebSocket å»£æ’­
  - ç·šç¨‹å®‰å…¨çš„é€£æ¥ç®¡ç†
  - è©³ç´°çš„å»£æ’­æ—¥èªŒ
- `chat.go`: WebSocket é€£æ¥è™•ç†
  - å¿ƒè·³æ©Ÿåˆ¶ï¼ˆ30 ç§’ç™¼é€ Pingï¼‰
  - å¿ƒè·³åŒ…éæ¿¾
  - ç©ºæ¶ˆæ¯éæ¿¾
  - è©³ç´°çš„é€£æ¥æ—¥èªŒ

---

## é–‹ç™¼è¦ç¯„

### 1. ç›´æ’­ç‹€æ…‹åŒæ­¥ â­ é‡è¦
**åŸå‰‡**: é–‹å§‹/åœæ­¢ç›´æ’­å¿…é ˆé€šçŸ¥æˆ¿é–“å…§æ‰€æœ‰ç”¨æˆ¶

**å¾Œç«¯ (SRS å›èª¿)**:
```go
// OnPublish - é–‹å§‹æ¨æµ
if oldStatus == "idle" {
  h.store.BroadcastToRoom(room.ID, map[string]interface{}{
    "type": "stream_started",
    "message": "ç›´æ’­å·²é–‹å§‹",
  })
  log.Printf("[STREAM_STARTED] Room: %s (ID: %s), Broadcasting to viewers", room.Title, room.ID)
}

// OnUnpublish - åœæ­¢æ¨æµ
if oldStatus == "live" {
  h.store.BroadcastToRoom(room.ID, map[string]interface{}{
    "type": "stream_stopped",
    "message": "ç›´æ’­å·²åœæ­¢",
  })
  log.Printf("[STREAM_STOPPED] Room: %s (ID: %s), Broadcasting to viewers", room.Title, room.ID)
}
```

**å‰ç«¯ (ç›£è½)**:
```dart
// ç›£è½é–‹å§‹ç›´æ’­äº‹ä»¶
_streamStartedSubscription = _wsService.onStreamStarted.listen((message) {
  setState(() {
    _roomStatus = 'live';
    _playerKey = UniqueKey();  // ğŸ”‘ å¼·åˆ¶é‡å»ºæ’­æ”¾å™¨
  });
  _initPlayer();
});

// ç›£è½åœæ­¢ç›´æ’­äº‹ä»¶
_streamStoppedSubscription = _wsService.onStreamStopped.listen((message) {
  setState(() {
    _roomStatus = 'idle';
  });
  _cleanupPlayer();
});
```

### 2. ç”¨æˆ¶é€²å…¥æˆ¿é–“è™•ç†
**åŸå‰‡**: ç”¨æˆ¶é€²å…¥æ™‚å¿…é ˆç²å–æˆ¿é–“æœ€æ–°ç‹€æ…‹

```dart
@override
void initState() {
  super.initState();
  _isHost = widget.user.id == widget.room.hostId;
  
  // é‡æ–°ç²å–æœ€æ–°ç‹€æ…‹ï¼ˆé¿å…ä½¿ç”¨èˆŠæ•¸æ“šï¼‰
  _fetchRoomStatus().then((_) {
    if (!_isHost && _roomStatus == 'live') {
      _initPlayer();  // å¦‚æœå·²åœ¨ç›´æ’­ï¼Œç«‹å³åˆå§‹åŒ–æ’­æ”¾å™¨
    }
  });
}

Future<void> _fetchRoomStatus() async {
  final room = await _apiService.getRoom(widget.room.id);
  setState(() {
    _roomStatus = room.status;
  });
  // é€£æ¥ WebSocket
  _wsService.connect(widget.room.id, widget.user.token);
}
```

### 3. æ’­æ”¾å™¨å¯¦ç¾ â­ ä¸è¦æ”¹å£
**åŸå‰‡**: ä¿æŒç°¡å–®å¯é çš„æ’­æ”¾å™¨å¯¦ç¾

**æ’­æ”¾å™¨é‡å»ºæ©Ÿåˆ¶**:
```dart
// åœ¨ State ä¸­å®šç¾©
Key _playerKey = UniqueKey();

// æ”¶åˆ°é–‹å§‹ç›´æ’­é€šçŸ¥æ™‚æ›´æ–°
setState(() {
  _playerKey = UniqueKey();  // å¼·åˆ¶ Flutter é‡å»ºæ’­æ”¾å™¨
});

// ä½¿ç”¨ key
AdaptiveVideoPlayer(
  key: _playerKey,  // ğŸ”‘ é—œéµï¼
  hlsUrl: _hlsUrl!,
  flvUrl: _flvUrl!,
)
```

**Web (video_player + HLS)**:
```dart
_videoController = VideoPlayerController.networkUrl(
  Uri.parse(hlsUrl),
  httpHeaders: {
    'Cache-Control': 'no-cache, no-store, must-revalidate',
    'Pragma': 'no-cache',
    'Expires': '0',
  },
);
```

**Mobile (fijkplayer + FLV)**:
```dart
_fijkPlayer = FijkPlayer();
// ä½å»¶é²é…ç½®
_fijkPlayer!.setOption(FijkOption.formatCategory, "fflags", "nobuffer");
_fijkPlayer!.setOption(FijkOption.playerCategory, "max_cached_duration", 3000);
await _fijkPlayer!.setDataSource(flvUrl, autoPlay: true);
```

**ç¦æ­¢**: 
- âŒ ä¸è¦ä½¿ç”¨ platformViewRegistry (Web API ä¸ç©©å®š)
- âŒ ä¸è¦ä½¿ç”¨è¤‡é›œçš„ dart:js äº’æ“ä½œ
- âŒ ä¸è¦å˜—è©¦ iframe + flv.js æ–¹æ¡ˆ (å®šä½å•é¡Œå¤š)
- âŒ ä¸è¦å¿˜è¨˜ä½¿ç”¨ UniqueKey å¼·åˆ¶é‡å»º

### 4. WebSocket é€šè¨Š â­ é‡è¦

**å‰ç«¯å¿ƒè·³æ©Ÿåˆ¶**:
```dart
// æ¯ 25 ç§’ç™¼é€å¿ƒè·³
_pingTimer = Timer.periodic(Duration(seconds: 25), (timer) {
  _channel!.sink.add(jsonEncode({'type': 'ping'}));
});
```

**å‰ç«¯éŒ¯èª¤è™•ç†**:
```dart
_channel!.stream.listen(
  (data) {
    // è™•ç†æ¶ˆæ¯
    final json = jsonDecode(data);
    if (json['type'] == 'stream_started') {
      _streamStartedController.add(json['message']);
    }
  },
  onError: (error) {
    print('âŒ [WebSocket] é€£æ¥éŒ¯èª¤: $error');
  },
  onDone: () {
    print('ğŸ”Œ [WebSocket] é€£æ¥å·²é—œé–‰');
    _stopPing();
  },
  cancelOnError: false,
);
```

**å¾Œç«¯å¿ƒè·³è™•ç†**:
```go
// è®€å–æ¶ˆæ¯æ™‚éæ¿¾å¿ƒè·³åŒ…
var msg struct {
  Type    string `json:"type"`
  Message string `json:"message"`
}

err := conn.ReadJSON(&msg)
if err != nil {
  log.Printf("[WS_DISCONNECT] ç”¨æˆ¶ %s é›¢é–‹æˆ¿é–“: %v", user.Nickname, err)
  return
}

// éæ¿¾å¿ƒè·³åŒ…
if msg.Type == "ping" {
  log.Printf("[WS_HEARTBEAT] æ”¶åˆ°ä¾†è‡ª %s çš„å¿ƒè·³", user.Nickname)
  continue  // ä¸å»£æ’­
}

// éæ¿¾ç©ºæ¶ˆæ¯
if msg.Message == "" {
  log.Printf("[WS_SKIP] è·³éç©ºæ¶ˆæ¯ - ç”¨æˆ¶: %s", user.Nickname)
  continue  // ä¸å»£æ’­
}
```

**å¾Œç«¯ Ping/Pong æ©Ÿåˆ¶**:
```go
// è¨­ç½® Pong è™•ç†å™¨
conn.SetPongHandler(func(string) error {
  log.Printf("[WS_PONG] æ”¶åˆ°ä¾†è‡ª %s çš„å¿ƒè·³å›æ‡‰", user.Nickname)
  conn.SetReadDeadline(time.Now().Add(60 * time.Second))
  return nil
})

// æ¯ 30 ç§’ç™¼é€ Ping
pingTicker := time.NewTicker(30 * time.Second)
defer pingTicker.Stop()

for {
  select {
  case <-pingTicker.C:
    log.Printf("[WS_PING] ç™¼é€å¿ƒè·³åˆ° %s", user.Nickname)
    if err := conn.WriteMessage(websocket.PingMessage, nil); err != nil {
      return
    }
  case <-done:
    return
  }
}
```

### 5. SRS é…ç½®
**æ–‡ä»¶**: `srs/conf/srs.conf`

**é—œéµé…ç½®**:
```nginx
vhost __defaultVhost__ {
    min_latency     on;
    gop_cache       off;              # é—œé–‰ GOP ç·©å­˜ï¼Œé¿å…èˆŠç•«é¢
    
    hls {
        hls_fragment    4;            # 4ç§’åˆ‡ç‰‡ï¼ˆé…åˆ OBS é—œéµå¹€ï¼‰
        hls_window      60;           # ä¿ç•™ 15 å€‹åˆ‡ç‰‡ï¼ˆ60ç§’ï¼‰
        hls_wait_keyframe on;         # ç­‰å¾…é—œéµå¹€åˆ‡ç‰‡
    }
    
    http_remux {
        enabled     on;               # HTTP-FLV æ”¯æ´
        fast_cache  2;
    }
    
    http_hooks {
        enabled         on;
        on_publish      http://api:3000/srs/on_publish;
        on_unpublish    http://api:3000/srs/on_unpublish;
    }
}
```

**æ³¨æ„**: 
- OBS é—œéµå¹€é–“éš”è¨­ç‚º 4 ç§’ï¼ŒSRS `hls_fragment` ä¹Ÿè¨­ç‚º 4
- ä¸è¦æ”¹å‹• OBS è¨­ç½®ï¼Œè€Œæ˜¯èª¿æ•´ SRS é…ç½®ä¾†é©é…

### 6. URL ç”Ÿæˆèˆ‡ç·©å­˜
**å¾Œç«¯ API**:
```go
// æ·»åŠ æ™‚é–“æˆ³é˜²æ­¢ç·©å­˜
timestamp := time.Now().UnixMilli()
return gin.H{
  "hls": fmt.Sprintf("http://localhost:8080/live/%s.m3u8?t=%d", streamKey, timestamp),
  "flv": fmt.Sprintf("http://localhost:8080/live/%s.flv?t=%d", streamKey, timestamp),
}
```

### 7. æˆ¿é–“åˆ—è¡¨
**åŸå‰‡**: ä»»ä½•ç‹€æ…‹çš„æˆ¿é–“éƒ½å…è¨±é€²å…¥

```dart
// âœ… æ­£ç¢º
onTap: () => Navigator.push(...),
trailing: room.isLive 
  ? Chip('ç›´æ’­ä¸­', backgroundColor: Colors.red)
  : Chip('ç­‰å¾…ä¸­', backgroundColor: Colors.grey),

// âŒ éŒ¯èª¤ - ä¸è¦ç¦ç”¨ idle æˆ¿é–“
onTap: room.isLive ? () => ... : null,
```

### 8. æ—¥èªŒè¦ç¯„

**å¾Œç«¯æ—¥èªŒæ¨™ç±¤**:
```go
log.Printf("[WS_CONNECT] âœ… ç”¨æˆ¶ %s åŠ å…¥æˆ¿é–“ %s", user.Nickname, room.Title)
log.Printf("[WS_DISCONNECT] ç”¨æˆ¶ %s é›¢é–‹æˆ¿é–“", user.Nickname)
log.Printf("[WS_PING] ç™¼é€å¿ƒè·³åˆ° %s", user.Nickname)
log.Printf("[WS_PONG] æ”¶åˆ°ä¾†è‡ª %s çš„å¿ƒè·³å›æ‡‰", user.Nickname)
log.Printf("[WS_HEARTBEAT] æ”¶åˆ°ä¾†è‡ª %s çš„å¿ƒè·³", user.Nickname)
log.Printf("[WS_SKIP] è·³éç©ºæ¶ˆæ¯ - ç”¨æˆ¶: %s", user.Nickname)
log.Printf("[CHAT] %s: %s", user.Nickname, msg.Message)
log.Printf("[BROADCAST] æˆ¿é–“ %s æœ‰ %d å€‹é€£æ¥å®¢æˆ¶ç«¯", roomID, len(clients))
log.Printf("[BROADCAST] æˆåŠŸç™¼é€åˆ° %d/%d å€‹å®¢æˆ¶ç«¯", successCount, len(clients))
log.Printf("[STREAM_STARTED] Room: %s, Broadcasting to viewers", room.Title)
log.Printf("[STREAM_STOPPED] Room: %s, Broadcasting to viewers", room.Title)
```

**å‰ç«¯æ—¥èªŒ**:
```dart
print('ğŸ”Œ [WebSocket] å˜—è©¦é€£æ¥: $url');
print('âœ… [WebSocket] é€£æ¥æˆåŠŸ');
print('ğŸ“© [WebSocket] æ”¶åˆ°åŸå§‹æ•¸æ“š: $data');
print('â–¶ï¸  [WebSocket] æ”¶åˆ°é–‹å§‹ç›´æ’­é€šçŸ¥');
print('â¹ï¸  [WebSocket] æ”¶åˆ°åœæ­¢ç›´æ’­é€šçŸ¥');
print('ğŸ’“ [WebSocket] ç™¼é€å¿ƒè·³');
print('ğŸ¬ [æ’­æ”¾å™¨] æˆ¿é–“ç‹€æ…‹: $_roomStatus');
```

---

## æ•…éšœæ’æŸ¥

### å•é¡Œ 1: ç•«é¢ä¸å‹•æˆ–é¡¯ç¤ºèˆŠç•«é¢
**åŸå› **: 
- HLS åˆ‡ç‰‡ç·©å­˜
- m3u8 æ’­æ”¾åˆ—è¡¨ç·©å­˜
- GOP ç·©å­˜æœªé—œé–‰

**è§£æ±º**:
1. ç¢ºèª `gop_cache off`
2. URL æ·»åŠ æ™‚é–“æˆ³
3. HTTP headers è¨­ç½® no-cache
4. é‡å•Ÿ SRS: `docker compose restart srs`

### å•é¡Œ 2: è§€çœ¾é€²å…¥æˆ¿é–“çœ‹ä¸åˆ°ç›´æ’­
**åŸå› **: 
- æˆ¿é–“ç‹€æ…‹æœªåŒæ­¥
- WebSocket é€šçŸ¥æœªè§¸ç™¼
- æ’­æ”¾å™¨æœªé‡å»º

**è§£æ±º**:
1. æª¢æŸ¥å¾Œç«¯ `OnPublish` æ˜¯å¦å»£æ’­ `stream_started`
2. æª¢æŸ¥å‰ç«¯æ˜¯å¦ç›£è½ `onStreamStarted`
3. æª¢æŸ¥å‰ç«¯ `initState` æ˜¯å¦å‘¼å« `_fetchRoomStatus()`
4. æª¢æŸ¥æ˜¯å¦ä½¿ç”¨ `UniqueKey` å¼·åˆ¶é‡å»ºæ’­æ”¾å™¨

### å•é¡Œ 3: å†æ¬¡é–‹æ’­æ™‚æ’­æ”¾å™¨ä¸å·¥ä½œ
**åŸå› **: 
- æ’­æ”¾å™¨å¯¦ä¾‹æœªé‡å»º
- Flutter èªç‚ºæ˜¯åŒä¸€å€‹ Widget

**è§£æ±º**:
```dart
// ä½¿ç”¨ UniqueKey å¼·åˆ¶é‡å»º
setState(() {
  _playerKey = UniqueKey();
});
```

### å•é¡Œ 4: èŠå¤©æ¶ˆæ¯ä¸åŒæ­¥æˆ–æœ‰ç©ºæ¶ˆæ¯
**åŸå› **: 
- å¿ƒè·³åŒ…è¢«ç•¶ä½œèŠå¤©æ¶ˆæ¯å»£æ’­
- å¾Œç«¯æ²’æœ‰éæ¿¾ç©ºæ¶ˆæ¯

**è§£æ±º**:
1. æª¢æŸ¥å¾Œç«¯æ˜¯å¦éæ¿¾ `type: ping` æ¶ˆæ¯
2. æª¢æŸ¥å¾Œç«¯æ˜¯å¦éæ¿¾ç©ºæ¶ˆæ¯
3. æŸ¥çœ‹å¾Œç«¯æ—¥èªŒï¼š`tail -f /tmp/backend.log | grep "\[WS_HEARTBEAT\]"`

### å•é¡Œ 5: WebSocket é€£æ¥æ„å¤–æ–·é–‹
**åŸå› **: 
- æ²’æœ‰å¿ƒè·³æ©Ÿåˆ¶
- ç¶²çµ¡é–’ç½®è¶…æ™‚

**è§£æ±º**:
1. ç¢ºèªå‰ç«¯æ¯ 25 ç§’ç™¼é€å¿ƒè·³
2. ç¢ºèªå¾Œç«¯æ¯ 30 ç§’ç™¼é€ Ping
3. ç¢ºèªå¾Œç«¯è¨­ç½® Pong è™•ç†å™¨
4. æŸ¥çœ‹é€£æ¥æ—¥èªŒ

### å•é¡Œ 6: å¾Œç«¯å»£æ’­æ²’æœ‰åˆ°é”å®¢æˆ¶ç«¯
**æª¢æŸ¥å¾Œç«¯æ—¥èªŒ**:
```bash
tail -f /tmp/backend.log | grep -E "\[BROADCAST\]|\[STREAM_STARTED\]"

# æ‡‰è©²çœ‹åˆ°:
# [STREAM_STARTED] Room: xxx, Broadcasting to viewers
# [BROADCAST] æˆ¿é–“ xxx æœ‰ 2 å€‹é€£æ¥å®¢æˆ¶ç«¯
# [BROADCAST] æˆåŠŸç™¼é€åˆ° 2/2 å€‹å®¢æˆ¶ç«¯
```

---

## æ¸¬è©¦æ¸…å–®

### å ´æ™¯ 1: è§€çœ¾å…ˆé€²å…¥ï¼Œä¸»æ’­å¾Œé–‹æ’­
- [ ] è§€çœ¾å¯ä»¥é€²å…¥ idle ç‹€æ…‹çš„æˆ¿é–“
- [ ] é¡¯ç¤ºã€Œç›´æ’­å°šæœªé–‹å§‹ã€
- [ ] ä¸»æ’­é–‹å§‹æ¨æµ
- [ ] è§€çœ¾æ”¶åˆ° `stream_started` é€šçŸ¥
- [ ] æ’­æ”¾å™¨è‡ªå‹•åˆå§‹åŒ–ä¸¦é–‹å§‹æ’­æ”¾ï¼ˆä½¿ç”¨æ–°çš„ UniqueKeyï¼‰
- [ ] å»¶é²åœ¨åˆç†ç¯„åœï¼ˆHLS: 15-20s, FLV: 1-3sï¼‰

### å ´æ™¯ 2: ä¸»æ’­å·²é–‹æ’­ï¼Œè§€çœ¾å¾Œé€²å…¥
- [ ] è§€çœ¾å¯ä»¥é€²å…¥ live ç‹€æ…‹çš„æˆ¿é–“
- [ ] è‡ªå‹•ç²å–æœ€æ–°æˆ¿é–“ç‹€æ…‹
- [ ] æ’­æ”¾å™¨ç«‹å³åˆå§‹åŒ–ä¸¦é–‹å§‹æ’­æ”¾

### å ´æ™¯ 3: ä¸»æ’­åœæ­¢æ¨æµå¾Œå†æ¬¡é–‹æ’­
- [ ] è§€çœ¾æ”¶åˆ° `stream_stopped` é€šçŸ¥
- [ ] é¡¯ç¤ºã€Œç›´æ’­å·²åœæ­¢ã€æç¤º
- [ ] æ’­æ”¾å™¨åœæ­¢ä¸¦æ¸…ç†
- [ ] ä¸»æ’­å†æ¬¡æ¨æµ
- [ ] è§€çœ¾æ”¶åˆ° `stream_started` é€šçŸ¥
- [ ] æ’­æ”¾å™¨**å®Œå…¨é‡å»º**ä¸¦é–‹å§‹æ’­æ”¾ï¼ˆé—œéµæ¸¬è©¦ï¼‰

### å ´æ™¯ 4: èŠå¤©åŒæ­¥
- [ ] ä¸»æ’­ç™¼é€æ¶ˆæ¯ï¼Œè§€çœ¾ç«‹å³æ”¶åˆ°
- [ ] è§€çœ¾ç™¼é€æ¶ˆæ¯ï¼Œä¸»æ’­ç«‹å³æ”¶åˆ°
- [ ] å…©é‚Šæ¶ˆæ¯åˆ—è¡¨å®Œå…¨ä¸€è‡´
- [ ] æ²’æœ‰ç©ºæ¶ˆæ¯å‡ºç¾
- [ ] å¿ƒè·³åŒ…ä¸æœƒå‡ºç¾åœ¨èŠå¤©ä¸­

### å ´æ™¯ 5: æˆ¿é–“åˆ—è¡¨
- [ ] é¡¯ç¤ºã€Œç›´æ’­ä¸­ã€(ç´…è‰²) æˆ–ã€Œç­‰å¾…ä¸­ã€(ç°è‰²)
- [ ] ä»»ä½•ç‹€æ…‹çš„æˆ¿é–“éƒ½å¯ä»¥é»æ“Šé€²å…¥
- [ ] æˆ¿é–“è§€çœ‹äººæ•¸æ­£ç¢ºé¡¯ç¤º

### å ´æ™¯ 6: WebSocket ç©©å®šæ€§
- [ ] é€£æ¥å¾Œ 5 åˆ†é˜å…§ä¸æ–·é–‹
- [ ] å¿ƒè·³æ—¥èªŒæ­£å¸¸è¼¸å‡º
- [ ] é•·æ™‚é–“ç©ºé–’å¾Œä»èƒ½æ­£å¸¸æ”¶ç™¼æ¶ˆæ¯

---

## Docker ç’°å¢ƒ

### å•Ÿå‹•æœå‹™
```bash
docker compose -f docker-compose-full.yml up -d
```

### é‡å•Ÿ SRSï¼ˆé…ç½®è®Šæ›´å¾Œï¼‰
```bash
docker compose -f docker-compose-full.yml restart srs
```

### é‡å•Ÿå¾Œç«¯ï¼ˆä»£ç¢¼è®Šæ›´å¾Œï¼‰
```bash
# æ–¹å¼ 1: ç›´æ¥é‡å•Ÿå®¹å™¨
docker compose -f docker-compose-full.yml restart api

# æ–¹å¼ 2: æœ¬åœ°é–‹ç™¼ï¼ˆæ¨è–¦ï¼‰
lsof -ti:3000 | xargs kill -9
cd /Users/mike/Documents/self/srs-mobile-demo/backend
go run main.go > /tmp/backend.log 2>&1 &
```

### æŸ¥çœ‹æ—¥èªŒ
```bash
# æŸ¥çœ‹æ‰€æœ‰æœå‹™
docker logs api --tail 50 -f
docker logs srs --tail 50 -f

# æœ¬åœ°é–‹ç™¼å¾Œç«¯æ—¥èªŒ
tail -f /tmp/backend.log

# éæ¿¾ç‰¹å®šé¡å‹æ—¥èªŒ
tail -f /tmp/backend.log | grep -E "\[WS_CONNECT\]|\[CHAT\]"
tail -f /tmp/backend.log | grep -E "\[BROADCAST\]|\[STREAM_"
tail -f /tmp/backend.log | grep "\[WS_HEARTBEAT\]"
```

### æ¸…ç†ä¸¦é‡æ–°å•Ÿå‹•ï¼ˆè§£æ±ºç·©å­˜å•é¡Œï¼‰
```bash
docker compose -f docker-compose-full.yml down
docker compose -f docker-compose-full.yml up -d
```

---

## API ç«¯é»

### æˆ¿é–“ç®¡ç†
- `GET /api/rooms` - ç²å–æˆ¿é–“åˆ—è¡¨
- `GET /api/rooms/:id` - ç²å–å–®å€‹æˆ¿é–“
- `POST /api/rooms` - å‰µå»ºæˆ¿é–“
- `GET /api/rooms/:id/play_url` - ç²å–æ’­æ”¾åœ°å€
- `PATCH /api/rooms/:id/status` - æ›´æ–°æˆ¿é–“ç‹€æ…‹
- `DELETE /api/rooms/:id` - åˆªé™¤æˆ¿é–“

### SRS å›èª¿
- `POST /srs/on_publish` - æ¨æµå›èª¿
- `POST /srs/on_unpublish` - åœæ­¢æ¨æµå›èª¿

### WebSocket
- `GET /chat/:room_id?token=xxx` - WebSocket é€£æ¥

---

## è¨˜ä½çš„åŸå‰‡

1. âœ… **ä¿æŒæ’­æ”¾å™¨ç°¡å–®**: ä½¿ç”¨æ¨™æº–çš„ video_player å’Œ fijkplayer
2. âœ… **ç‹€æ…‹åŒæ­¥è‡³é—œé‡è¦**: é–‹å§‹/åœæ­¢ç›´æ’­å¿…é ˆé€šé WebSocket é€šçŸ¥
3. âœ… **é€²å…¥æˆ¿é–“æ™‚é‡æ–°ç²å–ç‹€æ…‹**: ä¸è¦ä¿¡ä»»å¾åˆ—è¡¨é å¸¶ä¾†çš„ç‹€æ…‹
4. âœ… **ä½¿ç”¨ UniqueKey å¼·åˆ¶é‡å»º**: ç¢ºä¿æ’­æ”¾å™¨åœ¨å†æ¬¡é–‹æ’­æ™‚å®Œå…¨é‡å»º
5. âœ… **ä»»ä½•æˆ¿é–“éƒ½å…è¨±é€²å…¥**: idle å’Œ live ç‹€æ…‹éƒ½å¯é€²å…¥
6. âœ… **é…ç½® SRS è€Œé OBS**: ä¿æŒ OBS é»˜èªè¨­ç½®ï¼Œèª¿æ•´ SRS é…ç½®
7. âœ… **é˜²æ­¢ç·©å­˜**: URL æ™‚é–“æˆ³ + HTTP headers + é—œé–‰ GOP ç·©å­˜
8. âœ… **WebSocket å¿ƒè·³æ©Ÿåˆ¶**: å‰ç«¯ 25 ç§’ï¼Œå¾Œç«¯ 30 ç§’ Ping
9. âœ… **éæ¿¾å¿ƒè·³åŒ…**: å¾Œç«¯å¿…é ˆéæ¿¾ `type: ping` å’Œç©ºæ¶ˆæ¯
10. âœ… **è©³ç´°æ—¥èªŒ**: æ‰€æœ‰é—œéµæ“ä½œéƒ½è¦æœ‰æ—¥èªŒï¼Œæ–¹ä¾¿è¿½è¹¤å•é¡Œ
11. âŒ **ä¸è¦éåº¦å·¥ç¨‹åŒ–**: é¿å…è¤‡é›œçš„ JS äº’æ“ä½œå’Œ iframe æ–¹æ¡ˆ

---

## ç›¸é—œæ–‡æª”
- SRS æ–‡æª”: https://ossrs.net/lts/zh-cn/docs/v5/doc/introduction
- Flutter video_player: https://pub.dev/packages/video_player
- fijkplayer: https://pub.dev/packages/fijkplayer
- Gorilla WebSocket: https://github.com/gorilla/websocket
