# SRS 配置 - MVP 版本
# 目標：最簡單的推流和拉流配置

listen              1935;
max_connections     1000;
daemon              off;
srs_log_tank        console;

# HTTP API（用於查詢狀態）
http_api {
    enabled         on;
    listen          1985;
}

# HTTP Server（用於 HLS 拉流）
http_server {
    enabled         on;
    listen          8080;
    dir             ./objs/nginx/html;
}

# 統計信息
stats {
    network         0;
}

# 默認虛擬主機
vhost __defaultVhost__ {
    # 低延遲配置
    min_latency     on;             # 最小延遲模式
    
    # GOP 緩存（關閉，避免顯示舊直播間的畫面）
    gop_cache       off;            # 不緩存 GOP，避免串流問題
    queue_length    10;             # 播放隊列長度
    
    # TCP 優化
    tcp_nodelay     on;             # 禁用 Nagle 算法
    # HLS 配置（直播優化）
    hls {
        enabled         on;
        hls_path        ./objs/nginx/html;
        hls_fragment    4;          # 4秒切片（配合OBS關鍵幀）
        hls_window      60;         # 60秒窗口（15個切片）
        hls_cleanup     on;
        hls_dispose     0;
        hls_wait_keyframe on;       # 等待關鍵幀
        hls_aof_ratio   2.0;        # 音視頻同步
        hls_m3u8_file   [app]/[stream].m3u8;
        hls_ts_file     [app]/[stream]-[seq].ts;
    }
    
    # HTTP-FLV 配置（超低延遲，推薦）
    http_remux {
        enabled     on;
        mount       [vhost]/[app]/[stream].flv;
        fast_cache  2;              # 快速緩存（降低首屏時間）
    }
    
    # WebRTC 配置（超低延遲，可選）
    rtc {
        enabled     on;
        rtmp_to_rtc on;
        rtc_to_rtmp on;
    }
    
    # HTTP 回調（通知後端）
    http_hooks {
        enabled         on;
        
        # 推流開始（Docker 容器間通信）
        on_publish      http://api:3000/srs/on_publish;
        
        # 推流結束  
        on_unpublish    http://api:3000/srs/on_unpublish;
    }
}

